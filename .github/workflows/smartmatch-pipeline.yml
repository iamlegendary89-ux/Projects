name: SmartMatch Phone Intelligence Pipeline

on:
  schedule:
    - cron: "0 0 * * *" # Daily at midnight UTC
  workflow_dispatch: # Manual trigger only (no push trigger to avoid loops)

env:
  NODE_VERSION: "20"

concurrency:
  group: smartmatch-pipeline
  cancel-in-progress: true

jobs:
  # -----------------------------------------------------------------------------
  # UNIFIED PIPELINE JOB
  # Runs Discovery -> Enrichment -> OSET -> Sync in one go.
  # Persists results via Git Commit.
  # -----------------------------------------------------------------------------
  smartmatch-pipeline:
    name: ðŸš€ SmartMatch Pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write # For git push
      issues: write   # For failure notifications

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for git log history check in pipeline.ts

      - name: ðŸ”§ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      # -------------------------------------------------------------------------
      # ðŸƒâ€â™‚ï¸ RUN THE PIPELINE
      # This runs scripts/pipeline.ts which orchestrates all steps locally.
      # -------------------------------------------------------------------------
      - name: ðŸ”„ Execute Pipeline
        run: npm run pipeline
        env:
          # Supabase
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          # LLM API
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          # Google Custom Search Engine
          CUSTOM_SEARCH_API_KEY: ${{ secrets.CUSTOM_SEARCH_API_KEY }}
          SEARCH_ENGINE_ID: ${{ secrets.SEARCH_ENGINE_ID }}
          # Archive.org Save API
          IA_ACCESS_KEY: ${{ secrets.IA_ACCESS_KEY }}
          IA_SECRET_KEY: ${{ secrets.IA_SECRET_KEY }}

      # -------------------------------------------------------------------------
      # ðŸ’¾ PERSISTENCE (GIT COMMIT)
      # -------------------------------------------------------------------------
      - name: ðŸ’¾ Commit & Push Changes
        run: |
          # Configure Git
          git config --global user.name "SmartMatch Bot"
          git config --global user.email "bot@smartmatch.app"

          # Check status
          git status

          # Add all modified/created files (respects .gitignore)
          git add -A

          # Commit if changes exist
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit --no-verify -m "chore(data): daily pipeline update [skip ci]"
            git push
            echo "âœ… Data changes pushed to repo."
          fi

      # -------------------------------------------------------------------------
      # ðŸ“Š REPORTING (Still useful to see summary in Actions UI)
      # -------------------------------------------------------------------------
      - name: ðŸ“Š Pipeline Summary
        if: always()
        run: |
          if [ -f "PIPELINE_REPORT.md" ]; then
            cat PIPELINE_REPORT.md >> $GITHUB_STEP_SUMMARY
          fi

      # -------------------------------------------------------------------------
      # ðŸš¨ FAILURE NOTIFICATION
      # -------------------------------------------------------------------------
      - name: ðŸš¨ Create Failure Issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Pipeline Failed: ${new Date().toISOString().split('T')[0]}`;
            const body = `## Pipeline Failure Report
            
            **Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Time:** ${new Date().toISOString()}
            **Trigger:** ${context.eventName}
            
            Please check the [workflow logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['pipeline-failure', 'automated']
            });
