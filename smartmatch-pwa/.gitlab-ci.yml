stages:
  - test
  - quality
  - build
  - deploy

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  DOCKER_COMMON: &docker_common
    image: node:18
    before_script:
      - npm ci --cache .npm --prefer-offline
    cache:
      key: ${CI_COMMIT_REF_SLUG}
      paths:
        - .npm/
        - node_modules/

# Test Stage
test:unit:
  <<: *docker_common
  stage: test
  script:
    - npm run test -- --coverage --watchAll=false
    - mkdir -p coverage/
    - cp coverage/lcov-report/index.html coverage/index.html
  coverage: '/All files[^|]*\|[^|]*\s+All files[^|]*\|[^|]*\s+([^|]+)\|/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

test:integration:
  <<: *docker_common
  stage: test
  script:
    - npm run test:integration
  artifacts:
    paths:
      - test-results/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

# Quality Stage
lint:
  <<: *docker_common
  stage: quality
  script:
    - npm run lint -- --format=compact
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'

type_check:
  <<: *docker_common
  stage: quality
  script:
    - npm run type-check
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'

security_scan:
  <<: *docker_common
  stage: quality
  script:
    - npm audit --audit-level=moderate
    - echo "Running security scan..."
    - node scripts/check-esm-compatibility.js
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "schedule"'

# Build Stage
build:
  <<: *docker_common
  stage: build
  script:
    - npm run build
    - echo "Build version: $(node -p \"require('./package.json').version\")"
  artifacts:
    paths:
      - dist/
      - scripts/*.js
    expire_in: 1 week
  dependencies:
    - test:unit
    - lint
    - type_check
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

build:docker:
  stage: build
  image: docker:19.03.12
  services:
    - docker:19.03.12-dind
  script:
    - docker build -t $DOCKER_IMAGE -f Dockerfile .
    - docker push $DOCKER_IMAGE
  dependencies:
    - build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'

# Deploy Stage
deploy:staging:
  stage: deploy
  script:
    - echo "Deploying to staging environment..."
    - echo "Staging deployment complete"
  environment:
    name: staging
    url: https://smartmatch-staging.example.com
  dependencies:
    - build:docker
  only:
    - develop

deploy:production:
  stage: deploy
  script:
    - echo "Deploying to production environment..."
    - echo "Checking deployment health..."
    - echo "Production deployment complete"
  environment:
    name: production
    url: https://smartmatch.example.com
  dependencies:
    - build:docker
  only:
    - main
  when: manual

# Performance Testing
performance_test:
  <<: *docker_common
  stage: test
  script:
    - npm run test:performance
    - node scripts/performance-report-generator.js
  artifacts:
    paths:
      - performance-report.json
    expire_in: 1 week
  only:
    - schedules

# Cleanup
cleanup:
  <<: *docker_common
  stage: .post
  script:
    - echo "Cleaning up temporary files..."
    - rm -rf node_modules/.cache
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: on_failure

# Include templates for common configurations
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

# Override SAST settings for this project
sast:
  stage: quality
  variables:
    SAST_EXCLUDED_ANALYZERS: "spotbugs"  # Not needed for TypeScript/Node.js
