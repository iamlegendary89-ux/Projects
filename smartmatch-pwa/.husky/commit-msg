#!/bin/sh

commit_msg=$(cat $1)

# Check if this is a pipeline commit (should bypass conventional commit validation)
is_pipeline_commit=false

# Detection criteria for pipeline commits:
# 1. CI environment variables
if [ -n "$CI" ] || [ -n "$GITHUB_ACTIONS" ] || [ -n "$PIPELINE" ]; then
  is_pipeline_commit=true
fi

# 2. Pipeline message patterns
if echo "$commit_msg" | grep -qE "(ğŸ¤– Pipeline:|Auto-generated by|Pipeline:|CI/CD)"; then
  is_pipeline_commit=true
fi

# 3. Pipeline user identity (if git config is available)
pipeline_user=$(git config user.email 2>/dev/null || echo "")
if echo "$pipeline_user" | grep -qE "(pipeline@|bot@|ci@)"; then
  is_pipeline_commit=true
fi

# If this is a pipeline commit, skip validation
if [ "$is_pipeline_commit" = true ]; then
  echo "ğŸ¤– Pipeline commit detected - bypassing conventional commit validation"
  echo "âœ… Pipeline commit approved"
  exit 0
fi

# Conventional commit pattern: type(scope): description
conventional_pattern="^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\([^)]+\))?: .+$"

if ! echo "$commit_msg" | grep -qE "$conventional_pattern"; then
  echo "âŒ Invalid commit message format!"
  echo "ğŸ“‹ Format: type(subject): description"
  echo ""
  echo "Allowed types: build, chore, ci, docs, feat, fix, perf, refactor, revert, style, test"
  echo "Examples:"
  echo "  feat(auth): add user login functionality"
  echo "  fix(ui): resolve button alignment issue"
  echo "  docs(api): update endpoint documentation"
  echo "  test(validators): add error handling tests"
  echo ""
  exit 1
fi

echo "âœ… Commit message format validated"
